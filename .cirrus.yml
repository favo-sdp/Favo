#language: android
#android:
#  components:
#    # The BuildTools version used by your project (make sure it's exactly the same as in the build.gradle)
#    - build-tools-29.0.3
#    # The SDK version used to compile your project
#    - android-29
#    # The SDK version used by the system image
#    - android-22
#    # The system image, to run an emulator during the tests
#    - sys-img-armeabi-v7a-android-22
#
#before_install:
#  - chmod +x ./gradlew
#
#before_script:
#  # Emulator Management: Create, Start and Wait
#  - echo no | android create avd --force -n test -t android-22 --abi armeabi-v7a
#  - emulator -avd test -no-audio -no-window &
#  - android-wait-for-emulator
#  - adb shell input keyevent 82
#  # Set up Code Climate test reporter
#  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
#  - chmod +x ./cc-test-reporter
#  - ./cc-test-reporter before-build
#script:
#  - ./gradlew build connectedCheck jacocoTestReport
#after_script:
#  # Report test coverage to Code Climate
#  - export JACOCO_SOURCE_PATH=app/src/main/java/
#  - ./cc-test-reporter format-coverage ./app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml --input-type jacoco
#  - ./cc-test-reporter upload-coverage
connected_check_task:
  name: Run Android instrumented tests
  env:
    API_LEVEL: 28
    TARGET: default
    ARCH: x86
    CC_TEST_REPORTER_ID: "bc4464660f2cddebf28df2de0e6dfca705250d14d8cf7d982d90b40d2b632d03"
  container:
    image: reactivecircus/android-emulator-28:latest
    kvm: true
    cpu: 8
    memory: 24G
  create_device_script:
    echo no | avdmanager create avd --force --name "api-${API_LEVEL}" --abi "${TARGET}/${ARCH}" --package "system-images;android-${API_LEVEL};${TARGET};${ARCH}"
  start_emulator_background_script:
    $ANDROID_HOME/emulator/emulator -avd "api-${API_LEVEL}" -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -camera-back none
  wait_for_emulator_script:
    adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 3; done; input keyevent 82'
  disable_animations_script: |
    adb shell settings put global window_animation_scale 0.0
    adb shell settings put global transition_animation_scale 0.0
    adb shell settings put global animator_duration_scale 0.0
  prepare_codeclimate_script:
    - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
    - chmod +x ./cc-test-reporter
    - ./cc-test-reporter before-build
  run_instrumented_tests_script:
    ./gradlew build connectedCheck jacocoTestReport
  report_codeclimate_script:
    # Report test coverage to Code Climate
    - export JACOCO_SOURCE_PATH=app/src/main/java/
    - ./cc-test-reporter format-coverage ./app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml --input-type jacoco
    - ./cc-test-reporter upload-coverage



